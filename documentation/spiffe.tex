\documentclass[11pt]{article}
\usepackage{hyperref}
\usepackage[dvips]{graphicx}
%%% COMMANDREF
% created by M. Borland
%
% latex2html perl script can't recognize this when this
% definition is in the style file.
%
\newcommand{\commandref}[1]{\hyperref{#1}{{\tt #1} (}{)}{#1}}

\pagestyle{plain}
\tolerance=10000
\newenvironment{req}{\begin{equation} \rm}{\end{equation}}
\setlength{\topmargin}{0.15 in}
\setlength{\oddsidemargin}{0 in}
\setlength{\evensidemargin}{0 in} % not applicable anyway
\setlength{\textwidth}{6.5 in}
\setlength{\headheight}{-0.5 in} % for 11pt font size
%\setlength{\footheight}{0 in}
\setlength{\textheight}{9 in}
\begin{document}

\title{User's Guide for {\tt spiffe} Version 4.8}
\author{Michael Borland\\Advanced Photon Source\\ \date{\today}}
\maketitle

\section{Introduction}

This manual describes use of the program {\tt spiffe} (SPace charge and
Integration of Forces For Electrons).  Those wishing to understand the
algorithms used by {\tt spiffe} should consult reference \cite{spiffeEqn}.

\section{Changes}
\subsection{Version 4.8.0}

\begin{enumerate}
\item The \verb|define_field_sampling| command now uses the field interpolation routine to sample
  electric and magnetic fields, rather than simply taking fields from the problem grid. This means that
  all field components are included: (1) fields generated by antennae, (2) fields generated by the beam,
  (3) fields obtained from off-axis expansion, (3) fields obtained from electrostatic poentials, and (5) constant
  imposed fields. Previously, only 1 and 2 were represented in the output.
  The need for this was pointed out by P. Piot (NIU).
\item The \verb|define_field_sampling| command now accepts ``Ball'' and ``Eall'' as field requests, meaning
  that all components of $\vec{E}$ or $\vec{B}$ are sampled.
\end{enumerate}


\subsection{Version 4.7.1}
\begin{enumerate}
\item Added the \verb|define_emitter| command, which allows specifying emission from any
  surface. This was requested by J. Edelen (FNAL).
\item Fixed a bug in field interpolation near left-facing surfaces. This would affect secondary emission from such surfaces.
\item Fixed a bug in secondary emission routines due to an uninitialized pointer.
\end{enumerate}

\subsection{Version 4.6} 
\begin{enumerate}
\item When using \verb|load_particles| to load simulation particles from a file, in the past the
  particles had to enter through one of the three planes $z=z_{\textrm{min}}$, $z=z_{\textrm{max}}$, or
  $r=r_{\textrm{max}}$. If a metal boundary existed just inside the plane, particles would simply be
  eliminated. It is now possible for particles to enter through the metal boundary on the left-hand
  side of the simulation region. This feature was added following a request from J. Edelen (FNAL).
\item The beam snapshot (from \verb|define_snapshots|) now includes a \verb|status| column that
  indicates whether particles are active.
\end{enumerate}

\section{Run Organization}

A typical {\tt spiffe} run consists of the following steps, most of
which are optional.  Although the steps need not be executed
exactly in the order shown here, doing so will prevent the 
occasional error message.  Each step is performed by invoking a namelist 
command, as indicated:
\begin{enumerate}

\item Define the simulation region and the geometry of a cavity.  This
includes defining the grid sizes, the boundary conditions, which types
of fields to include (TE or TM), and how to interpolate on the grid.
This is done with the {\tt define\_geometry} command, which requires
existence of a boundary definition file in a POISSON-like format.
This file specifies not only the location of the metal surfaces
in the problem, but optionally the potential of each.

\item Optional: define the time-dependent fields and/or a method of
generating fields.  This is done with the {\tt load\_fields}, {\tt
define\_antenna}, and/or {\tt add\_on\_axis\_fields} commands.  The
former allows loading fields from a previous {\tt spiffe} run, whereas
the latter allows generating new fields using a modulated sine-wave
current source.

\item Optional: define solenoid coils, from which static magnetic
fields will be computed and imposed on the particle motion.
The {\tt define\_solenoid} command permits defining a solenoid
with a specified length, radius, symmetry, and current/field.

\item Optional: define constant field components to be imposed on the
simulation.  These field components, defined with the {\tt
constant\_fields} command, are not necessarily physical in that
they may not satisfy Maxwell's equations.

\item Optional: load a particle distribution and/or define a cathode
for generation of particles.  The former is not presently implemented
in version 2.0 of {\tt spiffe}.  The {\tt define\_cathode} namelist
permits specification of the size, current density, time profile,
and other parameters of particle emission from an annulus.  Starting
in version 2.3, multiple cathodes may be defined.

\item Optional: invoke and control Poisson correction.  This is
controlled by the {\tt poisson\_correction} command.  It is recommended
in order to increase the accuracy of the field solutions.  Without it,
numerical errors tend to build up that correspond to fictitious 
concentrations of static charge on the grid.

\item Optional: define resistive elements in the cavity interior,
which simulates the effect of walls that are less than perfectly
conducting.  This is done with one or more {\tt define\_resistor}
commands.  It slows the simulation tremendously, due to the reduced
step size needed to obtain numerical stability.

\item Optional: define a series of diagnostic ``screens'' for placement
in the beam path.  A single {\tt define\_screen} command can be used
to produce output of beam parameters at a series of equispaced
longitudinal positions.

\item Optional: request beam snapshots at equispaced time intervals.
This is done with the {\tt define\_snapshots} command.

\item Optional: request field output and/or field saving.  Field output
is in a format convenient for plotting and analysis, in that values
are interpolated onto the same grid for all field components.  Field
saves are intended for use by a subsequent spiffe run.  These operations
are set up by the {\tt define\_field\_output} and {\tt define\_field\_saving}
commands.

\item Optional: request sampling of the fields vs time or space
coordinates.  With the command\\ {\tt define\_field\_sampling}, one may set up
sampling of a specific field component along a line in z or r, with
output vs the distance along the line at specified times or else
output of the average value along the line vs time.

\item Optional: request reduction and translation of the simulation
grid so that it moves along with the particles.

\item Optional: request simulation of secondary emission, using the
{\tt define\_secondary\_emission} command.  This won't result in 
generation of any secondary particles unless a cathode is defined
or particles are loaded from a file.

\item Define integration parameters and begin integration.  The {\tt
integrate} command allows specifying the integration time step, the
total time to integrate, and other conditions of integration.
(Strictly speaking, it is optional, but only if you don't want to do
anything.)

\end{enumerate}

\section{Manual Pages}

The main input file for a {\tt spiffe} run consists of a series of
namelists, which function as commands.  Most of the namelists direct
{\tt spiffe} to set up to run in a certain way.  A few are ``action''
commands that begin the actual simulation.  FORTRAN programmers should
note that, unlike FORTRAN namelists, these namelists need not come in
a predefined order; {\tt spiffe} is able to detect which namelist is
next in the file and process appropriately.

Each namelist has a number of variables associated with it, which are
used to control details of the run.  These variables come in three
data types: (1) {\tt long}, for the C long integer type, (2) {\tt
double}, for the C double-precision floating point type, and (3) {\tt
STRING}, for a character string enclosed in double quotation marks.
All variables have default values, which are listed on the following
pages.  {\tt STRING} variables often have a default value listed as
{\tt NULL}, which means no data; this is quite different from the
value ``'', which is a zero-length character string.  {\tt long}
variables are often used as logical flags, with a zero value
indicating false and a non-zero value indicating true.

On the following pages the reader will find individual descriptions of
each of the namelist commands and their variables.  Each description
contains a sequence of the form
\begin{verbatim}
&<namelist-name>
    <variable-type> <variable-name> = <default-value>;
    .
    .
    .
&end
\end{verbatim}
This summarizes the parameters of the namelist.  Note, however, that the namelists are invoked in the form
\begin{verbatim}
&<namelist-name>
    [<variable-name> = <value> ,]
    [<array-name>[<index>] = <value> [,<value> ...] ,]
        .
        .
        .
&end
\end{verbatim}  The square-brackets enclose an optional component.  
Not all namelists require variables to be given--the defaults may be
sufficient.  However, if a variable name is given, it must have a
value.  Values for \verb|STRING| variables must be enclosed in double
quotation marks.  Values for \verb|double| variables may be in
floating-point, exponential, or integer format (exponential format
uses the `e' character to introduce the exponent).

\input{define_geometry.tex}
\input{geometryFile.tex}
\input{define_antenna.tex}
\input{load_fields.tex}
\input{constant_fields.tex}
\input{add_on_axis_fields.tex}
\input{define_solenoid.tex}
\input{define_cathode.tex}
\input{load_particles.tex}
\input{poisson_correction.tex}
\input{translate.tex}
\input{define_resistor.tex}
\input{define_screen.tex}
\input{define_secondary_emission.tex}
\input{define_snapshots.tex}
\input{define_field_output.tex}
\input{define_field_saving.tex}
\input{define_field_sampling.tex}
\input{integrate.tex}

\newpage
\begin{thebibliography}{1}

\bibitem{RSLaw} H. G. Kirk {\em et al.} in {\em Handbook of Accelerator
Physics and Engineering}, A. W. Chao and M. Tigner eds., section 2.4.2.1,
World Scientific, 1999, page 99.

\bibitem{spiffeEqn} M. Borland, {\em Summary of Equations and Methods
        Used in {\tt spiffe}}, APS/IN/LINAC/92-2, 29 June 1992.

\end{thebibliography}

\end{document}
